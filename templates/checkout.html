{% extends "base.html" %}

{% block content %}
<div class="checkout-container">
    <h2>Pay with Lightning</h2>
    <p class="product-name">{{ product.name }} - {{ "{:,}".format(product.price) }} sats</p>

    <div class="qr-container">
        <img src="data:image/png;base64,{{ qr_base64 }}" alt="Lightning Invoice QR Code" width="280" height="280">
    </div>

    <div class="invoice-text" id="invoice-text" onclick="copyInvoice()">
        {{ payment_request }}
    </div>

    <div class="expiry-timer" style="text-align: center; margin: 10px 0; font-weight: bold; color: #ff4444;">
        Expires in: <span id="time-remaining">--:--</span>
    </div>

    <div class="payment-status status-waiting" id="payment-status">
        <span class="spinner"></span>
        Waiting for payment...
    </div>

    <div class="how-to-pay">
        <h3>How to pay (using lncli):</h3>
        <ol>
            <li>Copy the invoice above (click it)</li>
            <li>In your terminal, run:<br>
                <code>alice payinvoice INVOICE</code>
            </li>
            <li>Type <code>yes</code> to confirm</li>
            <li>This page updates automatically!</li>
        </ol>
    </div>

    <a href="/" class="btn btn-back" style="margin-top: 20px;">Back to Store</a>
</div>
{% endblock %}

{% block scripts %}
<script>
    const rHash = "{{ r_hash }}";
    const productId = "{{ product.id }}";
    const creationDate = {{ creation_date }};
    const expirySeconds = {{ expiry }};
    const expiryTimestamp = creationDate + expirySeconds;
    let polling = true;

    function updateTimer() {
        const now = Math.floor(Date.now() / 1000);
        const remaining = expiryTimestamp - now;

        if (remaining <= 0) {
            document.getElementById('time-remaining').innerText = "EXPIRED";
            document.getElementById('payment-status').innerHTML = "Invoice Expired";
            document.getElementById('payment-status').className = "payment-status status-error";
            polling = false;
            return;
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        document.getElementById('time-remaining').innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (polling) {
            setTimeout(updateTimer, 1000);
        }
    }

    updateTimer();

    function copyInvoice() {
        const text = document.getElementById('invoice-text').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const el = document.getElementById('invoice-text');
            const original = el.style.borderColor;
            el.style.borderColor = '#4ec9b0';
            setTimeout(() => { el.style.borderColor = original; }, 1000);
        });
    }

    function checkPayment() {
        if (!polling) return;

        fetch('/api/check_payment/' + rHash)
            .then(r => r.json())
            .then(data => {
                if (data.settled) {
                    polling = false;
                    const status = document.getElementById('payment-status');
                    status.className = 'payment-status status-paid';
                    status.innerHTML = 'Payment received!';

                    setTimeout(() => {
                        window.location.href = '/success/' + productId;
                    }, 1500);
                } else {
                    setTimeout(checkPayment, 2000);
                }
            })
            .catch(() => {
                setTimeout(checkPayment, 3000);
            });
    }

    // Start polling for payment
    checkPayment();
</script>
{% endblock %}